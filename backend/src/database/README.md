# 数据库架构文档

## 📋 概述

AI智能合同分析管理系统的数据库使用PostgreSQL，通过Supabase进行管理。数据库设计遵循规范化原则，确保数据一致性和安全性。

## 🗄️ 表结构说明

### 核心业务表

#### 1. user_profiles（用户档案表）
- 扩展Supabase Auth的用户信息
- 存储用户角色、部门等业务信息

#### 2. contracts（合同表）
- 存储上传的合同文件信息
- 包含合同状态、分类、分析结果等

#### 3. contract_analysis（合同分析表）
- 存储AI分析结果
- 包含风险评估、合规检查等信息

#### 4. templates（模板表）
- 存储合同模板
- 支持变量替换和智能起草

#### 5. contract_drafts（合同草稿表）
- 存储基于模板生成的草稿
- 支持草稿状态管理

### 业务流程表

#### 6. approval_workflows（审批流程表）
- 管理合同审批流程
- 支持多级审批和状态跟踪

#### 7. risk_rules（风险规则表）
- 定义风险检测规则
- 支持关键词、模式匹配等规则类型

### 系统配置表

#### 8. system_config（系统配置表）
- 存储系统运行配置
- 支持AI模型、安全等配置项

## 🔒 安全特性

### 行级安全策略（RLS）
所有表都启用了RLS，确保用户只能访问自己的数据。

### 策略示例
- 用户只能访问自己的合同和分析结果
- 模板对所有用户可见（只读）
- 只有管理员可以管理风险规则和系统配置

## 🔄 数据关系

```
user_profiles (1) ←→ (n) contracts (1) ←→ (1) contract_analysis
                      ↓
                  (n) contract_drafts ← (1) templates
                      ↓
                  (1) approval_workflows
```

## 📊 索引优化

所有表都创建了适当的索引：
- 外键字段索引
- 状态字段索引
- 时间字段索引
- 分类字段索引

## 🚀 部署说明

### 迁移执行顺序
按顺序执行迁移文件：
1. `001_initial_schema.sql` - 基础表结构
2. `002_analysis_tables.sql` - 分析相关表
3. `003_additional_tables.sql` - 其他业务表
4. `004_security_policies.sql` - 安全策略
5. `005_sample_data.sql` - 示例数据

### 环境要求
- PostgreSQL 12+
- Supabase账户和项目
- 适当的数据库权限

## 🛠️ 维护建议

### 定期维护
- 监控数据库性能
- 定期备份数据
- 优化索引和查询

### 数据清理
- 定期清理过期的合同文件
- 归档历史分析数据
- 维护模板版本控制

## 📞 技术支持

如有数据库相关问题，请联系开发团队或参考Supabase文档。